<html>
<head>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
   <script
  src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"
  integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E="
  crossorigin="anonymous"></script>
  
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.6.2/jquery.contextMenu.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.6.2/jquery.ui.position.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.6.2/jquery.contextMenu.min.css">
<script type="text/javascript" src="lz-string.min.js"></script>
  <script type="text/javascript" src="default.js"></script>
  <script type="text/javascript">
  var map;
  $( document ).ready(function() {
		
		var playerData;
		var ws;	
		var isEditing = getParameterByName('editing') == "true";
		var entities = getEntities();
		
		
		var urlConfig = getParameterByName("config");
		
		if (urlConfig !=undefined && urlConfig.length > 0) {
			try {
				map = JSON.parse(LZString.decompressFromEncodedURIComponent(urlConfig));
			}catch(e) {
				alert("failed to load config");
				console.log(e);
				map = getDefault();
			}
		}else{
			map = getDefault();
		}
		init();
		
		$("html").css({
			'height':"1080px",
			'width':"1920px",
			'margin': "0px",
			'padding': "0px",
			'overflow' : "hidden"
		});
		
		$('body').css({
			'width':"100%",
			'height':"100%",
			'margin': "0px",
			'padding': "0px"
		})
		
		function init() {
		
			if(isEditing) {
				$(document.body).contextMenu({
							selector: '.container', 
							callback: function(key, options) {
								console.log(options);
								var m = "clicked: " + key;
								window.console && console.log(m); 
							},
							items: {
								"settings": {name: "settings", icon: "settings"}
							}
							
						});
				$(document.body).append($('<div></div>').html("EDIT MODE").css({'color':'#FFFFFF', 'top' :'50%', 'left' : '50%'}));
			}
		
			$.each(map.containers, function(i, container) {
				if (i == "disabled") 
					return;
					
				var div = $('<div></div>').attr({
					'id': i,
					'class' :'container'
				})
				.css({
					'top' :container.top,
					'left' :container.left,
					'position' : 'absolute',
					'cursor' :'move',
					'width': container.width,
					'height': container.height
				});
				
				
				
				
				if (isEditing) {
					div.resizable({
							handles: "se",
							containment: $(document.body), 
							stop: function(event, ui) {
								var id = $(ui.element).attr('id');
								map.containers[id].width = ui.size.width;
								map.containers[id].height = ui.size.height;
								updateUrlConfig();
							}
						})
						.sortable({ 
							revert: true,
							connectWith: '.container',
							update: updateContainerItemOrder
						})
						.draggable({ 
							containment: $(document.body), 
							scroll: false,
							stop: function(event, ui) {
								var id = $(ui.helper).attr('id');
								map.containers[id].left = ui.position.left;
								map.containers[id].top = ui.position.top;
								updateUrlConfig();
								}						
							})
						
						.css({
							'border' :'10px solid #FFFFFF'
						});
						
					
						
					$(document.body).css("background-color", '#000000');
				}
				
				
				$.each(container.items, function(i2, name) {
					var item = entities[name];
					
					if (!item.enabled)
						return;
					
					var itemDiv = $("<div></div>").addClass('hideIfSet').addClass('itemDiv');
					var img = $('<img></img>').attr({'id' : name});
					img.css("zoom" , container.scale + "%");
					itemDiv.append(img);
					
					
					switch (item.type) {
						case "charm":
							img.attr('src', "images/" + item.sprite);
							itemDiv.addClass('charmDiv');
							itemDiv.removeClass("hideIfSet");
							break;
							
						case "spell":
							img.attr('src', "images/" + item.levelSprites[0]);
							break;
						
						case "skill":
							img.attr('src', "images/" + item.sprite);
							break;
							
						case "item":
							img.attr('src', "images/" + item.sprite);
							if ("multiple" in item && item.multiple) {
								var countDiv = $('<div></div>').attr({ 'id': name + '_count'});
								countDiv.addClass('counter');
								itemDiv.append(countDiv);
							}
							break;
							
						case "generic":
							img.attr('src', "images/" + item.sprite);
							break;	
						default:
							break;
					}
					/*
					if (i2 % container.itemsPerRow == 0)
						itemDiv.css({"clear":"both"});*/
					
					div.append(itemDiv);
				});
			
				$('body').append(div);
			
			});
			connect();
		}
		
		function updateContainerItemOrder(event, ui) {
			$.each(map.containers, function(i, container) {
				container.items = $.map($('#' + i).find('img'), function(e, i) { return $(e).attr('id'); });
				$.each(container.items, function(i2, name) {
					var item = entities[name];
					
					if (!item.enabled)
						return;
						
					$('#' + name).css("zoom" , container.scale + "%");
					
					if (i2 % container.itemsPerRow == 0)
						$('#' + name).parent().css({"clear":"both"});
					else
						$('#' + name).parent().css({"clear":"none"});
				});
				
			})
			
		}
		
		
		function connect() {
			console.log("Connecting");
			try {
				var url = "localhost";
				var overrideUrl = getParameterByName("url");

				if (overrideUrl != undefined  && overrideUrl != null)
					url = overrideUrl;
					
				ws = new WebSocket("ws://" + url + ":11420/playerData");
				ws.onerror = function (error) {
					console.log(error);
				}
				ws.onopen = getPlayerData;
				
				ws.onmessage = function (evt) 
				{ 
					var received_msg = evt.data;
					
					var json = JSON.parse(received_msg);
					updatePlayerData(json);
				}
				ws.onclose = function(){
					// Try to reconnect in 5 seconds
					setTimeout(function(){connect()}, 5000);
				};
			}catch(e) {
				console.log(e);
			}
			
		}
				
		function getPlayerData() {
			console.log("Refreshing data");
			ws.send("json");
		}
		
		function updatePlayerData(minData) {
			
			if ("var" in minData) {
			console.log(minData);
				//data[minData.var] = minData.value;
				//Currently the individual events don't map properly for randomizer, asking for full dump instead until we have a auto-mapping.
				ws.send("json");
				return;
			}else{
			
				data = minData;
				console.log(data);
			}
			
			$.each(map.containers, function(i, container) {
				$.each(container.items, function(i2, name) {
					var item = entities[name];
					if (!item.enabled)
						return;
						
					var id = "#" + name;
					var img = $(id);
					
					if (name in data) {
						switch (item.type) {
							case "charm":
								setSelcted(data[name], id);
								if (!$(id).hasClass('selected'))
									$(id).hide();
								else
									$(id).show();
									
								if (data[name.replace('got', 'equipped')] && !img.hasClass('equipped') )
									img.addClass('equipped');
								else if (!data[name.replace('got', 'equipped')] && img.hasClass('equipped'))
									img.removeClass('equipped');
								var brokenId = name.replace("got","broken");
								if (brokenId in data) {
									if (data[brokenId]) {
										img.attr('src', "images/" + item.brokenSprite);
									}else{
										img.attr('src', "images/" + item.sprite);
									}
								}
								break;
								
							case "spell":
								setSelcted(data[name] > 0, id);
								if (data[name] == 2 && img.attr("src") != item.levelSprites[1])
									img.attr("src", "images/" + item.levelSprites[1]);
								else if (data[name] != 2 && img.attr("src") == item.levelSprites[1])
									img.attr("src", "images/" + item.levelSprites[0]);
								
								break;
							
							case "skill":
								setSelcted(data[name], id);
								
								break;
								
							case "item":
								if (! ("multiple" in item))
									setSelcted(data[name], id);
								else
								{
									setMultipleSelected(data[name] > 0, id);
									if (data[name] > 0) {
										$(id + '_count').html(data[name]).show();
									}else{
										$(id + '_count').hide();
									}
								}

								
								break;
								
							case "generic":
								setSelcted(data[name], id);
								
								break;	
						}
					}
				});
			});

			if ($('#hasDreamNail').length > 0 && $('#dreamNailUpgraded').length > 0) {
				if ($('#hasDreamNail').hasClass("selected") && $('#dreamNailUpgraded').hasClass("selected"))
					$('#hasDreamNail').removeClass("selected").parent().hide();
				else if ($('#hasDreamNail').hasClass("selected") && !$('#dreamNailUpgraded').hasClass("selected"))
					$('#dreamNailUpgraded').removeClass("selected").parent().hide();
				else
					$('#dreamNailUpgraded').removeClass("selected").parent().hide();
			}
			
			updateUrlConfig();
		
		}
		
		function updateUrlConfig() {
		console.log("Upading url string");
			config = LZString.compressToEncodedURIComponent(JSON.stringify(map));
			window.history.pushState(config, "", "Index.html?editing=" + (isEditing ? "true" :"false")+ "&config=" + config );
			
			if (config.length > 1900)
				alert("Developer Warning, config length is > 1900.  If you see this message let the developer know.");
		}
		
		function setSelcted(has, id) {
			if (has && !$(id).hasClass('selected')) 
				$(id).addClass('selected').parent().removeClass('hideIfSet');
			else if (!has && $(id).hasClass('selected'))
				$(id).removeClass('selected').parent().addClass('hideIfSet');
		}
		
		function setMultipleSelected(has, id) {
			if (has && !$(id).hasClass('multiple')) 
				$(id).addClass('multiple').parent().removeClass('hideIfSet');
			else if (!has && $(id).hasClass('multiple'))
				$(id).removeClass('multiple').parent().addClass('hideIfSet');
		}
		
		function getSubSortKeys(list) {
			return Object.keys(list).sort(function(a,b){
				if (list[a].order < list[b].order)
					return -1;
				if (list[a].order > list[b].order)
					return 1;
				return 0;
			});
		}
		
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
});
  </script>
  <style type="text/css">
    .ui-icon-gripsmall-diagonal-se {
		color: #FFFFFF;
	}
	
	.container > .hideIfSet {
		display:unset;
	}
	
	.container > .hideIfSet img{
		display:unset;
	}
	
	div.charmDiv > img {
		display:unset;
	}
	
	.charmDiv {
		background: url(images/slotBGsm.png) no-repeat;
		background-position: center;
		display:block;
	}
	
	.container img {
		-webkit-filter: grayscale(100%); /* Safari 6.0 - 9.0 */
		filter: grayscale(100%);
		position: relative;
		top: 50%;
		transform: translateY(-50%);
		display:block;
	}
	
	.container img.selected {
		-webkit-filter: grayscale(0%); /* Safari 6.0 - 9.0 */
		filter: grayscale(0%);
		border-radius: 50%;
		box-shadow: 0px 0px 40px 10px #07ff6e;
		display:block !important;
	}
	
	img.equipped {
		border-radius: 50%;
		box-shadow: 0px 0px 40px 10px #07ff6e;
	}

	.itemDiv { 
		width: 41px;
		height: 41px;
		vertical-align: middle;
		float:left;
		position:relative;
		display:block;
	}
			
	img.multiple {
		-webkit-filter: grayscale(0%); /* Safari 6.0 - 9.0 */
		filter: grayscale(0%);
		border-radius: 50%;
		box-shadow: 0px 0px 40px 10px #07ff6e;
		display:block !important;
	}
	
	div.counter {
		width: 19px !important;
		height: 19px !important;
		border-radius: 50%;
		box-shadow: 0px 0px 5px 2px #FFFFFF;
		position: absolute;
		top: 25px;
		left: 20px;
		background-color: #000000;
		color: #FFFFFF;
		text-align: center;
		vertical-align: middle;
		display:none;
	}

  </style>
  </head>
  <body>

  </body>
  </html>